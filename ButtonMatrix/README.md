# Матричная клавиатура 3x3 на Arduino

## Описание проекта

Проект реализует сканирование матричной клавиатуры 3x3 с использованием прямого доступа к регистрам AVR, таймерных прерываний и программного антидребезга.

## Принцип работы

### Матричное сканирование

Клавиатура организована как сетка 3×3, где 9 кнопок подключены через 6 проводов (3 строки + 3 столбца). Сканирование выполняется построчно:

1. Все строки устанавливаются в HIGH
2. Текущая строка переводится в LOW
3. Читается состояние всех столбцов
4. Нажатая кнопка замыкает строку на столбец → на столбце появляется LOW

```
Строки (выходы)     Столбцы (входы с подтяжкой)
     D2 ──┬──[BTN1]──┬──[BTN2]──┬──[BTN3]──┬── D5
     D3 ──┼──[BTN4]──┼──[BTN5]──┼──[BTN6]──┼── D6
     D4 ──┴──[BTN7]──┴──[BTN8]──┴──[BTN9]──┴── D7
```

### Работа с регистрами

| Регистр | Назначение |
|---------|------------|
| `DDRD` | Направление пинов (вход/выход) |
| `PORTD` | Установка значений выходов и подтяжки входов |
| `PIND` | Чтение состояния пинов |

### Таймерное прерывание

Timer1 настроен на срабатывание каждые 10 мс в режиме CTC. При каждом прерывании сканируется одна строка, полный цикл занимает 30 мс.

### Антидребезг

Для устранения дребезга контактов используется счётчик стабильности:

- При совпадении текущего и предыдущего чтения — счётчик увеличивается
- При расхождении — счётчик сбрасывается
- Состояние фиксируется после 3 стабильных чтений (~90 мс)

## Функциональность

- Определение нажатия/отпускания каждой кнопки
- Одновременное нажатие нескольких кнопок
- Фиксация времени начала и длительности нажатия
- Вывод событий только при изменении состояния
- Устранение дребезга контактов

## Структура кода

```
setup()           → Инициализация портов и таймера
setup_timer1()    → Настройка прерываний
ISR(TIMER1_COMPA) → Сканирование строки + антидребезг
loop()            → Обработка изменений состояния
report_*()        → Вывод в Serial
```

## Пример вывода

```
Matrix Keyboard
Pressed buttons: 1
Pressed buttons: 1, 4
Pressed buttons: 1, 4, 5
Pressed buttons: 1, 5
Button 4 released: duration 2217 ms, started at 2905 ms
Pressed buttons: 5
Button 1 released: duration 4404 ms, started at 1916 ms
Pressed buttons: none
Button 5 released: duration 2876 ms, started at 4222 ms
```

## Аппаратные требования

- Arduino Uno
- 9 тактовых кнопок или ползунковых переключателей
- 9 диодов
- Соединительные провода